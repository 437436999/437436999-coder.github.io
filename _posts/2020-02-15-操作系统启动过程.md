---
layout: post
title:操作系统启动过程
date: 2020-02-15
author: Max.C
header-img: 'assets/img/pro23.jpg'
catalog: true
tags: 操作系统
---

# 操作系统启动过程



一台计算机的启动是从CPU开始的，计算机操作系统启动的一般过程如下：

当我们启动计算机时，电源就开始向设备供电，此时电压还不太稳定。CPU首先进行初始化，当芯片组检测到电源已经开始稳定供电了，CPU马上就从初始化的位置开始执行指令，执行的指令地址保存在寄存器中。以8086CPU为例，寄存器CS和IP用于保存CPU接下来需要执行的指令地址，CPU会开始执行该位置的指令。

在计算机刚启动时，CS和IP会被初始化成固定的默认值，这个位置被固化了BIOS系统，即计算机**启动时会默认开始执行BIOS系统**。

## 一、BIOS

BIOS(Basic Input Output System)称为“基本输入输出系统”，是一组固化到计算机内主板上一个BIOS芯片中的程序，它保存着计算机最重要的**基本输入输出的程序、开机后自检程序和系统自启动程序**，它可从CMOS中读写系统设置的具体信息，是连接软件与硬件的一座“桥梁”，主要功能是为计算机提供最底层的、最直接的硬件设置和控制。

在计算机启动时，会立即读取BIOS芯片中的程序段，开始执行BIOS系统，进行自检及初始化。简单来说，BIOS的实现了对 CPU、内存等硬件设备进行检测和初始化，把安装在磁盘中的操作系统（如Windows，linux）加载到内存中，然后把CPU的执行控制权交给操作系统。

BIOS系统的执行会有以下几个阶段：

### 1、加电自检（POST）

加电自检（Power On Self Test，简称POST）用于电脑刚接通电源时对硬件部分的检测，功能是**检查电脑是否良好**，通常完整的POST自检将包括对CPU，基本内存，扩展内存，ROM，主板，CMOS存储器，串并口，显示卡，软硬盘子系统及键盘进行测试。一旦在自检中发现问题，系统会根据检测代码给出提示信息或鸣笛警告。（因为在自检的时候显卡还没有初始化，无法将错误信息显示在屏幕上，只能通过声音报告错误）

自检中如发现有错误，将按两种情况处理：对于严重故障（致命性故障）则停机，此时由于各种初始化操作还没完成，不能给出任何提示或信号；对于非严重故障则给出提示或声音报警信号，等待用户处理。

### 2、各设备自检

POST结束之后就会调用其它代码来进行更完整的硬件检测。这一过程的实现方法如下：系统BIOS调用各个设备的BIOS， 执行内部的初始化代码，对各个设备进行检测和初始化。

检测完所有其它设备之后，系统BIOS将显示出它自己的启动画面，其中包括有系统BIOS的类型、序列号和版本号等内容。

### 3、引导启动

当所有的硬件都检测完毕并没有问题后，BIOS会进入引导程序，交给引导程序让其引导启动。

如果我们自己安装过操作系统，我们就知道在安装系统的时候，有一道步骤是需要手动修改启动顺序，将启动引导向U盘/光盘中的安装程序上。而这也就是BIOS的启动代码的最后一项工作，即根据用户指定的启动顺序从软盘、硬盘或光驱启动。

也就是说，BIOS需要知道的是”下一阶段的启动程序”位于哪个设备。也就是说，BIOS需要有一个外部储存设备的排序，排在前面的设备就是优先转交控制权的设备。

![](/assets/post_img/2020-02-12/17.png)

## 二、**主引导记录**（MBR）

根据“启动顺序”，BIOS把控制器交给位于首位的存储设备，即根据用户指定的启动顺序从软盘、硬盘或光驱读取启动设备的引导记录（MBR）。如果没有找到，表明设备不能用于启动，控制权于是被转交给”启动顺序”中的下一个设备，如果找到引导记录会把电脑的控制权转给引导记录。

接下来就对主引导记录（MBR）做一个简单的介绍：

磁盘的存储是以扇区为基本单位的，我们的系统信息，包括系统启动引导代码(MBR)，都存储在这些扇区中，其中硬盘的0柱面、0磁头、1扇区称为主引导扇区，也叫主引导记录MBR。这一部分共有512个字节，简单来说，就是硬盘最前面的512个字节。

**这512个字节就称为主引导记录（MBR）**，它不属于任何一个操作系统，也不能用操作系统提供的磁盘操作命令来读取它。

主引导扇区由三个部分组成(共512字节)：

1. 启动代码（共446字节）

   用于检查分区表的正确性，在硬盘启动时检查分区表是否正确，并将系统控制转给**用户指定的并在分区表中登记了**的某个操作系统；或者将控制权交给硬盘上的**引导程序**（如Grub）

2. 磁盘分区表（DPT)
   由四个分区表项构成（每个16字节），负责**说明磁盘上的分区情况**。
   
3. 结束标志（共2个字节）
   偏移地址01FE--01FF的2个字节值为结束标志0x55和0xAA，是**主引导记录的有效标志**，如果该标志错误系统就不能启动。

![]( /assets/post_img/2020-02-12/25.png)

**分区表：**

硬盘分区表占据主引导扇区的64个字节(偏移01BE--01FD)，可以对四个分区的信息进行描述，每个分区16字节。

每个分区的信息如下：

| 长度 (字节、位) | 意义                                                         |
| ----- | ------------------------------------------------------------ |
| 1字节 | 引导标志(Boot Indicator)：00-->非活动分区；80--> 活动分区；其它数值没有意义 |
| 1字节 | 开始磁头(Start Head)                                         |
| 6位   | 起始扇区(Start Sector)：使用1个字节中的低6位，即0~5位        |
| 10位  | 起始柱面(Start Cylinder)：使用上个字节中的高2位，再加上1个字节8位，共10位 |
| 1字节 | 分区类型描述(Partition type indicator)：定义了分区的类型     |
| 1字节 | 结束磁头(End Head)                                           |
| 6位   | 结束扇区(End Sector ) 使用1个字节中的低6位，即0~5位          |
| 10位  | 结束柱面（End Cylinder ）使用上个字节中的高2位，再加上1个字节8位，共10位 |
| 4字节 | 本分区之前使用的扇区数(Sector preceding partition)：该分区的起始物理扇区地址 |
| 4字节 | 本分区的总扇区数(Sector in partition)：该分区所包含的扇区总数 |



找到主引导记录后，计算机会将其放入内存的指定位置中并开始执行，实现以下功能：

- 检查硬盘分区表是否完好。
- 在分区表中寻找可引导的“活动”分区。
- 将活动分区的第一逻辑扇区内容装入内存。

主引导记录会将计算机的控制权转交给硬盘的某个分区，具体操作为：读取分区表，找到其中的活动分区，读取该活动分区的第一个分区（分区引导记录PBR），并将其加载到内存中。

通过分区引导记录，计算机可以得到操作系统在该分区的位置，计算机就会开始加载操作系统了。这种启动方式适用于一般单操作系统的启动过程。

如果计算机安装了多个操作系统，除了直接通过分区引导记录加载操作系统之外，MBR还可以将控制权交给启动引导程序（boot loader），在启动引导程序中决定启动哪一个操作系统。

## 三、启动引导程序（boot loader）

启动引导程序用来加载操作系统内核文件，通过boot loader，用户可以选择计算机安装好的不同的操作系统。boot loader可以存在MBR中，也可以存在文件系统的引导扇区中。

![]( /assets/post_img/2020-02-12/23.png)



1、以Windows为例，在安装Windows的时候，Windows系统会默认在MBR内会安装一份boot loader，并且在系统的引导扇区内也会安装有boot loader。

#### Windows Boot Manager

Windows系统的boot loader —— Windows Boot Manager，中文名称为Windows开机管理程序或Windows启动管理器。

当电脑执行完POST后，传BIOS会根据启动磁区寻找开机硬盘中标记"启动"分区下的BOOTMGR档案；接著BOOTMGR会读取启动配置信息数据库（BCD, Boot Configuration Database）中的启动配置参数，接著根据其中的配置加载预设或使用者所选择的操作系统。

![]( /assets/post_img/2020-02-12/24.png)



2、在安装Linux的时候，我们可以选择将boot loader安装在MBR，也可以选择不安装在MBR中，目前Linux常用的boot loader为Grub。

#### Grub：

Grub是一个来自GNU项目的多操作系统启动程序，它允许用户可以在计算机内同时拥有多个操作系统，并在计算机启动时选择希望运行的操作系统。

Grub可用于选择操作系统分区上的不同内核，也可用于向这些内核传递启动参数。

如果是通过Grub启动操作系统，MBR会引导将Grub装载至内存，启动Grub的开始执行程序：

![]( /assets/post_img/2020-02-12/10.png)

grub被载入通常包括以下步骤：

（1）装载基本的引导装载程序——stage1，主要功能就是装载第二引导程序：stage2。

（2）装载第二引导装载程序——stage2，这第二引导装载程序实际上是引出更高级的功能， 以允许用户装载入一个特定的操作系统。在GRUB中，这步是让用户显示一个菜单或是输入命令。该阶段引导的最终状态就是执行boot命令，将操作系统内核加载进入内存中，进而将控制权转交给内核。

Grub一般位于`/boot/grub`目录中，如图所示：

![]( /assets/post_img/2020-02-12/22.png)

## 四、操作系统

控制权转交给操作系统后，首先会把操作系统内核载入内存，通过一系列的步骤完成操作系统的启动。

以Linux系统为例，系统将内核放置在内存之中，并调用start_kernel()函数来启动一系列的初始化函数并初始化各种设备，完成Linux核心环境的建立。

内核加载完毕，会启动Linux操作系统第一个守护进程init，然后通过该进程读取`/etc/inittab`文件，`/etc/inittab`文件的作用是设定Linux的运行等级，决定进程运行模式。

读取完运行级别，Linux系统执行第一个用户层文件`/etc/rc.d/rc.sysinit`，该文件功能包括：设定PATH运行变量、设定网络配置、启动swap分区、设定/proc、系统函数等。

然后，系统读取`/etc/modules.conf`文件及`/etc/modules.d`目录下的文件来加载系统内核模块。

根据之前读取的运行级别，操作系统还会运行rc0.d到rc6.d中的相应的脚本程序，来完成相应的初始化工作和启动相应的服务。

启动完相应服务之后，会读取执行`/etc/rc.d/rc.local`文件，系统会逐行去执行并启动相应命令。

在加载完系统的各个模块之后，最终执行`/bin/login`程序，启动到系统登录界面，操作系统等待用户输入用户名和密码，即可完成操作系统的启动。

## 五、总结

操作系统的启动简单来说有以下几个步骤：

启动——BIOS自检——BIOS初始化——引导操作系统——启动操作系统

## 六、补充（UEFI启动）

除了BIOS引导开机，现在的很多计算机都使用了UEFI引导系统，省去了bios自检过程，所以可加快开机启动速度。我们也可以查询自己的计算机的引导模式，以我自己的计算机为例，这台电脑的引导模式也是UEFI引导。

![]( /assets/post_img/2020-02-12/9.png)

UEFI，全称“统一的可扩展固件接口”，这是 Intel 为个人电脑固件提出的启动系统的建议标准。其主要目的是为了在windows系统加载(启动)之前，提供操作系统启动服务。

BIOS先要对CPU初始化，然后跳转到BIOS启动处进行POST自检，此过程如有严重错误，则电脑会用不同的报警声音提醒，接下来采用读中断的方式加载各种硬件，完成硬件初始化后进入操作系统启动过程。

而UEFI引导的流程是开机初始化UEFI，然后引导操作系统，进入操作系统，和BIOS引导相比，少了一道BIOS自检过程，节省了加载系统时间。

UEFI直接运行预加载环境先直接初始化CPU和内存，CPU和内存若有问题则直接黑屏，其后启动PXE，采用枚举方式搜索各种硬件并加载驱动，完成硬件初始化，之后同样进入操作系统启动过程。

传统BOIS是由硬件及软件构成，同样，UEFI也是由硬件和软件构成。从使用者的角度分析，UEFI的操作界面更加的人性化、布局更加的合理。目前，集成UEFI的笔记本基本上是具备UEFI的基础功能，设置界面和传统BIOS设置界面集成在一起。只有一些高端主板才具备完整的UEFI设置界面。同时，UEFI具备以下优点。

1：可以支持2TB及以上硬盘引导操作系统。

2：UEFI可以快速的引导系统或者从休眠状态恢复。

3：UEFI可以和传统BIOS集成使用。

4：UEFI必须配合GPT分区才可以引导win10操作系统。