---
layout: post
title: 双目匹配
date: 2019-11-06
author: Max.C
header-img: 'assets/img/pro4.jpg'
catalog: true
tags: openCV 
---

# 一、双目匹配基本步骤


双目匹配实际操作主要分为4个步骤：相机标定—图像校正—双目立体匹配—获取深度。

### 相机标定：

张氏相机标定法利用不同角度拍摄的多张棋盘图像，计算出相应的内参：$f_x, f_y, c_x, c_y$（内参）,以及畸变系数$k_1,k_2,k_3,p_1,p_2$（径向畸变、切向畸变参数）。

然后进行外参的标定，得到两个相机的旋转矩阵和平移向量，再通过左右相机的内外参数，通过立体标定对左右两幅图像进行立体校准和对齐，最后确定两个相机的相对位置。

### 图像校正：

首先通过畸变系数进行畸变校正，径向畸变的校正公式为：

$x_c=x(1+k_1r^2+k_2r^4+k_3r^6)$

$y_c=y(1+k_1r^2+k_2r^4+k_3r^6)$

切向畸变的校正公式为：

$x_c=x+[2p_1y+p_2(r^2+2x^2)]$

$y_c=y+[2p_2x+p_1(r^2+2y^2)]$

然后进行立体校正，使得左右图像的成像原点坐标一致、两摄像头光轴平行、左右成像平面共面，这样一幅图像上任意像素点与其在另一幅图像上的对应点一定在同一行上，只需要对该行进行一维搜索即可匹配到对应点。

如下图，经过图像校正将两幅灰色图像校正为下侧共面的图像。

![](C:/Users/34961/Desktop/科研导师/image/2.png)

### 双目立体匹配：

双目立体匹配是把左右图像上对应的像素点匹配起来，得到视差图。

由于经过了立体校正后，匹配点是在同一行上的，所以可以在两张图的同一行中查找匹配点，通过匹配点得到每个点的视差d（下文提及）。

### 获取深度：

 经过上面步骤的调整，我们找到了图像中对应点的参数，可以通过公式$z=\frac{b f}{d}$算出图像中各像素点所对应的深度信息，得到深度图。

公式$z=\frac{b f}{d}$的推导如下：

已知焦距为f，基线距离为b，左相机中所求像素点对于图像中心的偏移量$(xl,yl)$，右相机中对应像素点对于图像中心的偏移量$(xr,yr)$，我们需要求的是深度z，如下图：

![](C:/Users/34961/Desktop/科研导师/image/1.png)

通过相似三角形的知识得到式子$z=f\times\frac{x}{xl},z=f\times\frac{x-b}{xr}$

有z、x两个未知量，由第一道式子有$x=\frac{z \cdot  xl}{f}$

代入第二道式子：$z=f\times\frac{\frac{z \cdot  xl}{f}-b}{xr}=\frac{z\cdot xl-bf}{xr}$

化简得$z=\frac{bf}{xl-xr}$

我们将xl-xr定义为视差d，则$z=\frac{bf}{d}$。



------



***
